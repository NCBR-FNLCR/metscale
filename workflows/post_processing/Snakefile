'''
Author: Chris Grahlmann
Affiliation: Signature Science

Date: 2019-05-01
Documentation: docs/workflow_comparison.md
'''

from os.path import join
import  glob

##################################################
# Post processing rules

data_dir = config['data_dir']
biocontainers = config['biocontainers']
taxclass = config['taxonomic_classification']
assembly = config['assembly']
readfilt = config['read_filtering']
comparison = config['comparison']
post_processing = config['post_processing']


##################################################
# Post processing build rules

# Skip to the very end of the file 
# to see the high-level build rules
# that trigger cascades of workflow
# tasks.


##################################################


#We need to get the files if they have been moved to the completed dir.
output_dir_pattern = post_processing['move_samples_to_dir']['output_pattern']
file_ext = readfilt['quality_trimming']['sample_file_ext']

workflows = config['workflows']
#all_sample_names = workflows['samples_input_workflow']['samples']
sample_files_dir_mv = []
sample_files_mv = []
for sample in all_sample_names:
    input_file_pattern = readfilt['read_patterns']['pre_trimming_glob_pattern']
    input_file_pattern = input_file_pattern.replace(file_ext,'')
    sample_file = re.sub(r"\*", sample, input_file_pattern, 1)
    print("sample_file: "+str(sample_file))
    sample_file_dir = output_dir_pattern.replace("{sample}", sample_file)
    sample_file_dir = join(data_dir, sample_file_dir)
    if os.path.isdir(sample_file_dir):
        sample_files_dir_mv.append(sample_file_dir)
print("sample_files_dir_mv: "+str(sample_files_dir_mv))


##########################################################

samples_output_dir = join(data_dir, output_dir_pattern)


def get_input_files(wildcards):
    input_files = []
    sample_input = wildcards
    search_pattern = readfilt["read_patterns"]["reverse_pe_pattern_search"]
    replace_pattern = readfilt["read_patterns"]["reverse_pe_pattern_replace"]

    #forward string pattern
    input_file_pattern1 = join(data_dir,"{sample}*")
    input_file_pattern = expand(input_file_pattern1, sample = sample_input)
    input_files.extend(glob.glob(str(input_file_pattern[0])))

    #reverse string pattern
    input_rev_str = str(sample_input).replace(search_pattern, replace_pattern)
    input_rev_str_pattern = join(data_dir,input_rev_str)
    input_rev_str_pattern = input_rev_str_pattern+"*"
    input_files.extend(glob.glob(input_rev_str_pattern))
    return input_files

print("samples_output_dir: "+str(samples_output_dir))
rule move_samples_to_dir:
    '''
    move files to seperate dir after processing
    '''
    output:
        directory(samples_output_dir)
    params:
        output_dir = samples_output_dir,
        input_files = get_input_files
    message: 
        '--- Moving files to samples dir'
    shell:
        "post_processing/move_completed_files.sh {params.output_dir} {params.input_files}"


##################################################
# post processing: create the final HTML report



def get_sample_filenames(wildcards):
    finshed_file_pattern = post_processing['move_samples_to_dir']['output_pattern']
    finshed_file_pattern = finshed_file_pattern.replace('{sample}','')
    finished_file = wildcards.sample_mv.split(finshed_file_pattern)[0]
    finished_file = finished_file.replace(data_dir,'')
    finished_file = wildcards.sample_mv + finished_file
    print("get_sample_filenames: "+str(finished_file))
    return finished_file

#This is not correct.
def get_sample_dir(wildcards):
    print("wildcards.sample_mv "+str(wildcards.sample_mv))
    return wildcards.sample_mv

html_output_file = post_processing['move_samples_to_dir']['out_pattern']
print("html_output_file: "+ str(html_output_file))
rule generate_r_script:
    '''
    generate R script for final reports
    '''
    output:
        html_output_file
    params:
        input_dir = get_sample_dir,  
        input_files = get_sample_filenames
    script:
        #'bash echo"OUTPUT"'
        "0-summary-report.Rmd"

 

 ###################################
# Post Processing: build rules      



rule post_processing_move_samples_dir_workflow:
    '''
    Build rule: Move all output files to subdir
    '''
    input:
        expand( samples_output_dir,
                sample    = sample_input_files,
        )


rule post_processing_create_final_report_workflow:
    '''
    Build rule: Crate a final HTML report
    '''
    input:
        expand( html_output_file,
                sample_mv    = sample_files_dir_mv,
                #sample     = 'data/SRR606249_subset10_1_reads_finished',
        )